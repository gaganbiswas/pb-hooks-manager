<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hooks Manager</title>
    <style>
      :root {
        --bg-app: #ffffff;
        --bg-sidebar: #f9fafb;
        --border-color: #e5e7eb;
        --text-main: #111827;
        --text-muted: #6b7280;
        --danger: #dc2626;
      }

      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: -apple-system, system-ui, sans-serif;
        background: var(--bg-app);
        color: var(--text-main);
      }

      .app-container {
        display: flex;
        height: 100vh;
      }

      .sidebar {
        width: 260px;
        background: var(--bg-sidebar);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
      }
      .sidebar-header {
        padding: 1.25rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .brand {
        font-weight: 600;
        font-size: 0.85rem;
        letter-spacing: 0.05em;
      }
      .tree {
        padding: 1rem;
        overflow-y: auto;
        font-size: 0.85rem;
      }

      .folder-group {
        margin-bottom: 0.25rem;
      }
      .folder-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .folder-label {
        font-weight: 600;
        padding: 0.4rem 0;
        cursor: default;
      }
      .folder-children {
        margin-left: 0.75rem;
        border-left: 1px solid var(--border-color);
        padding-left: 0.75rem;
      }
      .tree-item {
        padding: 0.4rem 0.6rem;
        cursor: pointer;
        border-radius: 4px;
        color: var(--text-muted);
        transition: all 0.1s;
      }
      .tree-item:hover {
        background: #f3f4f6;
        color: var(--text-main);
      }

      .main-editor {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .editor-header {
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 1.5rem;
        border-bottom: 1px solid var(--border-color);
      }
      #current-path {
        font-family: monospace;
        font-size: 0.75rem;
        color: var(--text-muted);
      }

      #editor-wrapper {
        position: relative;
        flex: 1;
        overflow: hidden;
        background: #fff;
      }
      #editor,
      #highlight-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 30px;
        font-family: "SFMono-Regular", Consolas, monospace;
        font-size: 14px;
        line-height: 1.6;
        border: none;
        white-space: pre;
        overflow: auto;
        tab-size: 4;
        box-sizing: border-box;
      }
      #editor {
        color: transparent;
        background: transparent;
        caret-color: #000;
        z-index: 2;
        resize: none;
        outline: none;
      }
      #highlight-layer {
        z-index: 1;
        pointer-events: none;
        background: #fff;
      }
      pre[class*="language-"] {
        background: #fff !important;
        margin: 0 !important;
      }

      button {
        background: #fff;
        border: 1px solid var(--border-color);
        color: var(--text-main);
        padding: 5px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.75rem;
        font-weight: 500;
      }
      .btn-primary {
        background: var(--text-main);
        color: #fff;
        border: none;
      }
      .btn-danger {
        color: var(--danger);
        border: none;
        background: transparent;
      }
      .btn-icon-small {
        padding: 0 4px;
        opacity: 0;
        font-size: 1rem;
      }
      .folder-header:hover .btn-icon-small {
        opacity: 1;
      }
      button:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      .route-list {
        margin-left: 1.5rem;
        margin-bottom: 0.5rem;
        border-left: 1px dashed var(--border-color);
        padding-left: 0.5rem;
      }

      .route-entry {
        font-size: 0.7rem;
        font-family: monospace;
        padding: 2px 0;
        display: flex;
        gap: 6px;
        align-items: center;
        color: var(--text-muted);
      }

      .method {
        font-weight: bold;
        font-size: 0.6rem;
        padding: 1px 4px;
        border-radius: 3px;
        text-transform: uppercase;
      }

      .method.get {
        background: #dcfce7;
        color: #166534;
      }
      .method.post {
        background: #dbeafe;
        color: #1e40af;
      }
      .method.put {
        background: #fef9c3;
        color: #854d0e;
      }
      .method.delete {
        background: #fee2e2;
        color: #991b1b;
      }

      .route-entry .path {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      #editor,
      #highlight-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 20px;
        font-family: "Fira Code", "SFMono-Regular", Consolas, monospace;
        font-size: 12px;
        line-height: 1.5;
        border: none;
        white-space: pre;
        overflow: auto;
        tab-size: 4;
        box-sizing: border-box;
      }

      .tree-item.active {
        background: #f3f4f6;
        color: var(--text-main);
      }

      #save-btn:disabled {
        background: #f3f4f6;
        color: #9ca3af;
        border: 1px solid var(--border-color);
        cursor: not-allowed;
        opacity: 0.7;
      }

      #save-btn {
        transition: all 0.2s ease;
      }
    </style>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  </head>
  <body>
    <div class="app-container">
      <aside class="sidebar">
        <div class="sidebar-header">
          <a class="logo logo-sm"
            ><img
              src="../_/images/logo.svg"
              alt="PocketBase logo"
              width="40"
              height="40"
          /></a>
          <div class="header-actions">
            <button onclick="createNewFile()">+ File</button>
            <button onclick="createNewFolder()">+ Folder</button>
          </div>
        </div>
        <div id="file-tree" class="tree"></div>
      </aside>

      <main class="main-editor">
        <header class="editor-header">
          <span id="current-path">no file selected</span>
          <div class="editor-actions">
            <button
              id="delete-btn"
              disabled
              onclick="deleteItem()"
              class="btn-danger"
            >
              Delete
            </button>
            <button
              id="save-btn"
              disabled
              onclick="saveFile()"
              class="btn-primary"
            >
              Saved
            </button>
          </div>
        </header>

        <div id="editor-wrapper">
          <pre
            id="highlight-layer"
          ><code id="highlight-code" class="language-js"></code></pre>
          <textarea
            id="editor"
            spellcheck="false"
            oninput="updateEditor()"
            onscroll="syncScroll()"
          ></textarea>
        </div>
      </main>
    </div>
    <script>
      // piggyback admin token from /_ dashboard
      const SUPERUSER_TOKEN = JSON.parse(
        localStorage.getItem("pb_admin_auth")
      )?.token;

      if (
        !SUPERUSER_TOKEN ||
        JSON.parse(atob(SUPERUSER_TOKEN.split(".")[1])).exp <
          Math.round(Date.now() / 1000)
      ) {
        window.location.href = window.location.origin + "/_/#/login";
      }

      let currentFilePath = "";
      let lastSavedContent = "";
      const editor = document.getElementById("editor");
      const codeLayer = document.getElementById("highlight-code");
      const saveBtn = document.getElementById("save-btn");

      /**
       * Global Fetch Wrapper
       */
      async function pbFetch(url, options = {}) {
        options.headers = {
          ...options.headers,
          Authorization: SUPERUSER_TOKEN,
        };
        const res = await fetch(url, options);
        if (res.status === 401 || res.status === 403)
          window.location.href = window.location.origin + "/_/#/login";
        return res;
      }

      function updateEditor() {
        let content = editor.value;

        if (content === lastSavedContent) {
          saveBtn.disabled = true;
          saveBtn.innerText = "Saved";
        } else {
          saveBtn.disabled = false;
          saveBtn.innerText = "Save Changes";
        }

        if (content[content.length - 1] == "\n") content += " ";
        codeLayer.textContent = content;
        Prism.highlightElement(codeLayer);
      }

      function syncScroll() {
        const pre = document.getElementById("highlight-layer");
        pre.scrollTop = editor.scrollTop;
        pre.scrollLeft = editor.scrollLeft;
      }

      /**
       * Key Listeners: Tab, Brackets, and Ctrl+S
       */
      editor.addEventListener("keydown", function (e) {
        const start = this.selectionStart;
        const end = this.selectionEnd;
        const pairs = { "(": ")", "[": "]", "{": "}", '"': '"', "'": "'" };

        if (e.key === "Tab") {
          e.preventDefault();
          this.value =
            this.value.substring(0, start) + "\t" + this.value.substring(end);
          this.selectionStart = this.selectionEnd = start + 1;
          updateEditor();
        }
        if (pairs[e.key]) {
          e.preventDefault();
          this.value =
            this.value.substring(0, start) +
            e.key +
            pairs[e.key] +
            this.value.substring(end);
          this.selectionStart = this.selectionEnd = start + 1;
          updateEditor();
        }
        if ((e.ctrlKey || e.metaKey) && e.key === "s") {
          e.preventDefault();
          saveFile();
        }
      });

      async function fetchTree() {
        const res = await pbFetch(`/hooks-manager/folder`);
        if (!res.ok) return;
        const data = await res.json();
        renderTree(data, document.getElementById("file-tree"));
      }

      /**
       * Load File with Auto-Save protection
       */
      async function loadFile(path, skipPush = false) {
        // Check if current file has unsaved changes before switching
        if (currentFilePath && editor.value !== lastSavedContent) {
          saveBtn.innerText = "Saving...";
          await saveFile(true);
        }

        const res = await pbFetch(`/hooks-manager/file?path=${path}`);
        if (!res.ok) return;

        const content = await res.text();
        currentFilePath = path;
        lastSavedContent = content;

        document.getElementById("current-path").innerText = path;
        editor.value = content;
        document.getElementById("delete-btn").disabled = false;

        if (!skipPush) {
          const url = new URL(window.location);
          url.searchParams.set("file", path);
          window.history.pushState({}, "", url);
        }

        await fetchTree();
        updateEditor();
      }

      /**
       * Save File logic
       * @param {boolean} silent - If true, skips the tree refresh to speed up navigation
       */
      async function saveFile(silent = false) {
        if (!currentFilePath || editor.value === lastSavedContent) return;

        saveBtn.innerText = "Saving...";

        const res = await pbFetch(
          `/hooks-manager/file?path=${currentFilePath}`,
          {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: editor.value }),
          }
        );

        if (res.ok) {
          lastSavedContent = editor.value;
          updateEditor();
          if (!silent) await fetchTree();
        }
      }

      async function createNewFile() {
        let name = prompt("File name:");
        if (!name) return;
        if (!name.endsWith(".pb.js")) name = name.split(".")[0] + ".pb.js";

        const initialContent = `routerAdd("GET", "/api/${
          name.split(".")[0]
        }", (e) => {\n\treturn e.json(200, { "message": "hello" });\n});`;

        await pbFetch(`/hooks-manager/file?path=${name}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ contents: initialContent }),
        });
        fetchTree();
      }

      async function createNewFolder() {
        const name = prompt("Folder name:");
        if (name) {
          await pbFetch(`/hooks-manager/folder?path=${name}`, {
            method: "PUT",
          });
          fetchTree();
        }
      }

      async function deleteItem(path) {
        const target = path || currentFilePath;
        if (!target || !confirm(`Delete ${target}?`)) return;

        await pbFetch(`/hooks-manager/file?path=${target}`, {
          method: "DELETE",
        });

        if (target === currentFilePath) {
          // Reset editor if current file is deleted
          currentFilePath = "";
          lastSavedContent = "";
          editor.value = "";
          const url = new URL(window.location);
          url.searchParams.delete("file");
          window.history.pushState({}, "", url);
          updateEditor();
        }
        fetchTree();
      }

      function renderTree(data, container, parentPath = "") {
        container.innerHTML = "";
        data.forEach((item) => {
          const el = document.createElement("div");

          if (typeof item === "object" && !item.type) {
            // Folder
            const name = Object.keys(item)[0];
            const full = parentPath ? `${parentPath}/${name}` : name;
            el.className = "folder-group";
            el.innerHTML = `
                <div class="folder-header">
                    <span class="folder-label"><svg width='12' height='12' xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16">
  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12.667A1.334 1.334 0 0 1 13.667 14H2.333A1.334 1.334 0 0 1 1 12.667V3.333A1.333 1.333 0 0 1 2.333 2H5.5L7 4h6.667A1.333 1.333 0 0 1 15 5.333v7.334Z"/>
</svg> ${name}</span>
                    <button class="btn-icon-small btn-danger" onclick="deleteItem('${full}')"><svg width='12' height='12' xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16">
  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5.5 4V2.25A1.25 1.25 0 0 1 6.75 1h2.5a1.25 1.25 0 0 1 1.25 1.25V4M2 4h12m-1 0v9.625A1.375 1.375 0 0 1 11.625 15h-7.25A1.375 1.375 0 0 1 3 13.625V4h10Z"/>
</svg></button>
                </div>
                <div class="folder-children"></div>`;
            renderTree(item[name], el.querySelector(".folder-children"), full);
          } else {
            // File
            const full = parentPath ? `${parentPath}/${item.name}` : item.name;
            const activeClass = currentFilePath === full ? "active" : "";

            let routesHtml = (item.routes || [])
              .map(
                (r) => `
                <div class="route-entry">
                    <span class="method ${r.method.toLowerCase()}">${
                  r.method
                }</span>
                    <span>${r.path}</span>
                </div>`
              )
              .join("");

            el.innerHTML = `
                <div class="tree-item ${activeClass}" onclick="loadFile('${full}')"><svg width='12' height='12' xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16">
  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10 1H3.4A1.4 1.4 0 0 0 2 2.4v11.2A1.4 1.4 0 0 0 3.4 15h9.2a1.4 1.4 0 0 0 1.4-1.4V5m-4-4 4 4m-4-4v4h4"/>
</svg> ${item.name}</div>
                <div class="route-list">${routesHtml}</div>`;
          }
          container.appendChild(el);
        });
      }

      window.onload = async () => {
        await fetchTree();
        const file = new URLSearchParams(window.location.search).get("file");
        if (file) loadFile(file, true);
      };
    </script>
  </body>
</html>
